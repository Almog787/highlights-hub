name: Update Live Streams

on:
  schedule:
    - cron: '0 */6 * * *' # רץ כל 6 שעות
  workflow_dispatch: # מאפשר לך להריץ ידנית בלחיצת כפתור ב-GitHub

# הוספת הרשאות כתיבה כדי שהבוט יוכל לדחוף את הקובץ ל-Repository
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # מושך את כל ההיסטוריה כדי למנוע שגיאות pull

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      - name: Run Scraper
        run: python scraper.py

      - name: Commit and Push changes
        run: |
          git config --global user.name 'Stream-Bot'
          git config --global user.email 'bot@gnn.com'
          
          # הוספת הקובץ שנוצר
          git add streams.json
          
          # בדיקה אם יש בכלל שינויים לפני שעושים Commit
          if git diff --staged --quiet; then
            echo "No changes detected in streams.json"
          else
            git commit -m "Auto-update live streams [skip ci]"
            
            # פתרון לשגיאת ה-Push: ביצוע Pull עם Rebase למניעת התנגשויות
            git pull --rebase origin main
            
            # דחיפה לשרת
            git push origin main
          fi
